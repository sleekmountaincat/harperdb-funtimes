name: harperdb-load-test

on: [workflow_dispatch, push]

jobs:
  harperdb-load-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: setup docker compose
        uses: docker/setup-compose-action@v1

      - name: setup k6
        uses: grafana/setup-k6-action@v1

      - name: start harperdb and metrics stack
        run: docker compose -f .ci/harperdb-metric-stack-compose.yaml up -d

      - name: wait for harperdb, install prom exporter
        run: |
          .ci/scripts/wait-for-harperdb-install-prom-exporter.sh
        timeout-minutes: 1

      - name: start container monitor
        run: |
          .ci/scripts/harperdb-container-monitor.sh &
        timeout-minutes: 1

      - name: load test data
        run: |
          .ci/scripts/load-data.sh
        timeout-minutes: 1

      - name: run load test
        run: |
          .ci/scripts/run-load-tests.sh

      - name: grab dashboard screenshot
        run: |
          curl -s -u "admin:admin" "http://localhost:3000/render/d/load-test/dashboard?width=1920&height=1200&from=now-7m&to=now&kiosk" --output dashboard.png

      - name: build load test summary
        run: |
          IMAGE_URL=$(curl -s -F "file=@dashboard.png" https://0x0.st)
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Load Test Results
          ![Dashboard]($IMAGE_URL)
          
          ## K6 Summaries
          \`\`\`
          Test                | Avg (ms)  | Requests | Rate (req/s) | Failed %
          ------------------- | --------- | -------- | ------------ | --------
          SQL Analytics       | $(printf "%9.2f" $(jq -r '.metrics.http_req_duration.avg' sql-analytics-summary.json)) | $(printf "%8s" $(jq -r '.metrics.http_reqs.count' sql-analytics-summary.json)) | $(printf "%12.2f" $(jq -r '.metrics.http_reqs.rate' sql-analytics-summary.json)) | $(printf "%8.2f" $(jq -r '.metrics.http_req_failed.rate' sql-analytics-summary.json | awk '{printf "%.2f", $1*100}'))
          Search Conditions   | $(printf "%9.2f" $(jq -r '.metrics.http_req_duration.avg' search-by-conditions-summary.json)) | $(printf "%8s" $(jq -r '.metrics.http_reqs.count' search-by-conditions-summary.json)) | $(printf "%12.2f" $(jq -r '.metrics.http_reqs.rate' search-by-conditions-summary.json)) | $(printf "%8.2f" $(jq -r '.metrics.http_req_failed.rate' search-by-conditions-summary.json | awk '{printf "%.2f", $1*100}'))
          Search Wildcard     | $(printf "%9.2f" $(jq -r '.metrics.http_req_duration.avg' search-by-value-wildcard-summary.json)) | $(printf "%8s" $(jq -r '.metrics.http_reqs.count' search-by-value-wildcard-summary.json)) | $(printf "%12.2f" $(jq -r '.metrics.http_reqs.rate' search-by-value-wildcard-summary.json)) | $(printf "%8.2f" $(jq -r '.metrics.http_req_failed.rate' search-by-value-wildcard-summary.json | awk '{printf "%.2f", $1*100}'))
          Insert              | $(printf "%9.2f" $(jq -r '.metrics.http_req_duration.avg' insert-summary.json)) | $(printf "%8s" $(jq -r '.metrics.http_reqs.count' insert-summary.json)) | $(printf "%12.2f" $(jq -r '.metrics.http_reqs.rate' insert-summary.json)) | $(printf "%8.2f" $(jq -r '.metrics.http_req_failed.rate' insert-summary.json | awk '{printf "%.2f", $1*100}'))
          \`\`\`
    
          Generated on: $(date)
          EOF

      - name: upload results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            *-summary.json
            dashboard.png